= Apache Camel 4.x Upgrade Guide

This document is for helping you upgrade your Apache Camel application
from Camel 4.x to 4.y. For example, if you are upgrading Camel 4.0 to 4.2, then you should follow the guides
from both 4.0 to 4.1 and 4.1 to 4.2.

== Upgrading Camel 4.4 to 4.5

=== camel-core

Camel startup summary will now report total number of routes without (internal routes created by Kamelets or Rest DSL).
This ensures the total number better reflect the total number of user created routes. The summary now includes a separate
number of Kamelets and Rest DSL routes. See also the camel-kamelet section.

The following deprecated methods from the `AbstractCamelContext`, deprecated on 4.2 as part of CAMEL-19998, were finally removed:

* `setTypeConverter`
* `getOrCreateTypeConverter`
* `setManagementMBeanAssembler`
* `getRestRegistryFactory`
* `setRestRegistryFactory`
* `setTransformerRegistry`
* `setValidatorRegistry`
* `setName`
* `setDescription`
* `getBootstrapFactoryFinder`
* `getFactoryFinder`
* `addInterceptStrategy`
* `getStartupStepRecorder`
* `setStartupStepRecorder`
* `resolvePropertyPlaceholders`
* `getBasePackageScan`
* `setBasePackageScan`

Users of these methods should use the respective operations from the `ExtendedCamelContext` (accessed via `getCamelContextExtension()`),
instead.

=== Rest DSL

Camel has changed the default value for `inlineRoutes=false` to `inlineRoutes=false` in `restConfiguration`.
It is very typical to define Rest DSL and for each service api, then call a Camel route via `direct` endpoints.
By inlining these two, then you only have 1 route in Camel instead of 2. This helps reduce the clutter of routes
that otherwise is in use when using Rest DSL and many services. You can restore to old behaviour by setting the option back to `inlineRoutes=false`.

Rest DSL will now eager resolve property placeholders that are used during building the `rest:` endpoint.

For example with a Rest DSL using a placeholder (`app.mypath = helloapp`) in the `path`:

[source,yaml]
----
- rest:
    path: "{{app.mypath}}"
    post:
      - to: direct:demo
----

Will not be resolved in the `rest` endpoint which can be seen during startup logging:

[source,text]
----
Routes startup (total:2)
Started demo (rest://post:%7B%7Bapp.mypath%7D%7D)
----

The placeholder is now resolved eager and you will see _nicer_ startup logs such as:

[source,text]
----
Routes startup (total:2)
Started demo (rest://post:helloapp)
----


=== Intercept EIP

The `interceptFrom` and `interceptSentToEndpoint` EIPs is now storing the intercepted endpoint using key `Exchange.INTERCEPTED_ENDPOINT`
as exchange property instead of a header.

Before:

[source,java]
----
String uri = exchange.getIn().getHeader(Exchange.INTERCEPTED_ENDPOINT, String.class);
----

After:

[source,java]
----
String uri = exchange.getProperty(Exchange.INTERCEPTED_ENDPOINT, String.class);
----

=== camel-kamelet

Routes created by Kamelets are no longer registered as JMX MBeans to avoid cluttering up with unwanted MBeans, as a Kamelet
is intended to act like a Camel component, despite its implementation is Camel routes. This means that the number of routes
listed from JMX will no longer include Kamelet routes.

The old behaviour can be enabled by setting `registerRoutesCreateByKamelet=true`
on the `ManagementAgent` object. See more in the xref:jmx.adoc[JMX] documentation.

=== camel-micrometer and camel-metrics

Due to Kamelets are changed to act more like a Camel component, and not expose internal details as JMX MBeans, then
micrometer and metrics no longer include statistics for those Kamelet routes.

The old behaviour can be enabled by setting `registerRoutesCreateByKamelet=true`
on the `ManagementAgent` object. See more in the xref:jmx.adoc[JMX] documentation.

=== camel-kamelet

Routes created by Kamelets are no longer registered as JMX MBeans to avoid cluttering up with unwanted MBeans, as a Kamelet
is intended to act like a Camel component, despite its implementation is Camel routes. This means that the number of routes
listed from JMX will no longer include Kamelet routes.

The old behaviour can be enabled by setting `registerRoutesCreateByKamelet=true`
on the `ManagementAgent` object. See more in the xref:jmx.adoc[JMX] documentation.

=== camel-micrometer and camel-metrics

Due to Kamelets are changed to act more like a Camel component, and not expose internal details as JMX MBeans, then
micrometer and metrics no longer include statistics for those Kamelet routes.

The old behaviour can be enabled by setting `registerRoutesCreateByKamelet=true`
on the `ManagementAgent` object. See more in the xref:jmx.adoc[JMX] documentation.

=== camel-platform-http-vertx

Added a Cookie Handler allowing the addition, retrieval and expiry of Cookies.